#!/bin/bash

mode="$1"
submode="$2"
prj=$(basename $PWD)

# export SILE_PATH=/mnt/builds/fontproof
# export CTR_UHB=0
guest=$HOME/guest
priv=../$prj-private
locl=${PWD/ci\//}-local
ref=$locl/references
var=$locl/variable
cmp=$locl/compare
dev=$locl/dev
rc=$dev/smithrc
ht=$dev/dev.css
bv=$dev/bumpversion.cfg
wl=$guest/wordlist.txt

if [ ! -d $ref ]
then
    echo "Dev directory $ref does not exist"
fi

if [ ! -d $var ]
then
    echo "Dev directory $var does not exist"
fi

if [ ! -d $cmp ]
then
    echo "Dev directory $cmp does not exist"
fi

if [ -f $rc ]
then
    source $rc
else
    echo "Dev file $rc does not exist"
fi

if [ ! -f $ht ]
then
    echo "Dev file $ht does not exist"
fi

if [ ! -f $bv ]
then
    echo "Dev file $bv does not exist"
fi

if [ ! -f $wl ]
then
    echo "Dev file $wl does not exist"
fi

if [ ! -f wscript ]
then
    echo "Must be in the root of the project"
    exit 1
fi

if [ $HOSTNAME = apple ]
then
    if [ -f wscript ]
    then
        rrun=../rrun-$prj
        if [ ! -x $rrun ]
        then
            echo "You are in $PWD which is not on the ramdisk, exiting..."
            exit 1
        fi
    fi
fi

if [ "$mode" == "bisect" ]
then
    repo="$submode"
    if [ -d "$repo" ]
    then
        pushd $repo
        smith distclean
        smith configure
        smith build
        if [ ! -f results/*-Regular.ttf ]
        then
            echo "broken build"
            exit 1
        fi
        echo "successful build"
        exit 0
        popd
    fi
fi

if [ "$mode" == "diff" ]
then
    pushd results
    for ttf in *.ttf
    do
        diffenator2 diff -fb ../references/$ttf -fa $ttf --user-wordlist $wl -o $guest
    done
    popd
    exit 0
fi

if [ "$mode" == "ots" ]
then
    for output in *_?tf
    do
        if [ ! -d $output ]
        then
            continue
        fi
        flavor=$(echo $output | cut -d _ -f 2)
        for font in $output/*.$flavor
        do
            namestyle=${font%.$flavor}
            ots-sanitize $font > /dev/null 2> ${namestyle}-ots.log
        done
        ls -l -S $output/*-ots.log
    done
    if [ -d results ]
    then
        $HOME/.local/bin/smith ots
    fi
    exit 0
fi

if [ "$mode" == "validate" ]
then
    for output in *_?tf
    do
        if [ ! -d $output ]
        then
            continue
        fi
        flavor=$(echo $output | cut -d _ -f 2)
        for font in $output/*.$flavor
        do
            namestyle=${font%.$flavor}
            fontval $font &
        done
        wait
    done
    if [ -d results ]
    then
        # $HOME/.local/bin/smith validate
        for ttf in results/*.ttf
        do
            fontval $ttf &
        done
        wait
    fi
    exit 0
fi

if [ "$mode" == "zip" ]
then
    for output in *_?tf
    do
        if [ ! -d $output ]
        then
            continue
        fi
        flavor=$(echo $output | cut -d _ -f 2)
        for font in $output/*.$flavor
        do
            pathnamestyle=${font%.$flavor}
            namestyle=${pathnamestyle#$output/}
            download=$(echo $namestyle | cut -d \- -f 1)
            mkdir $download
            cp $font $download
        done
        for txt in *.txt
        do
            unix2dos -n $txt $download/$txt
            chmod 644 $download/$txt
        done
        zip -r $download $download
    done
    if [ -d results ]
    then
        $HOME/.local/bin/smith zip
    fi
    exit 0
fi

if [ "$mode" == "var" ]
then
    pushd variable_ttf
    fontbakery check-googlefonts *.ttf --html fontbakery.html -q -F -S # --succinct
    fontspector -q --full-lists -p ~/script/variable.toml --html fontspector.html *.ttf
    for ttf in *.ttf
    do
        echo "Checking $ttf"
        stem=${ttf%.ttf}
        fonttools varLib.interpolatable --html fonttools-$stem.html $ttf
        interpolatable $ttf
        echo "much more detail: fonttools varLib.interpolatable --show-all $ttf"
    done
    popd
    exit 0
fi

if [ "$mode" == "qa" -o "$mode" == "qas" ]
then
    for output in *_?tf results
    do
        if [ ! -d $output ]
        then
            continue
        fi
        fontspector -q --full-lists -p googlefonts --html $output/fontspector.html $output/*.ttf
        if [ "$mode" == "qas" ]
        then
            fontbakery check-googlefonts $output/*.ttf --html $output/fontbakery.html -q -F -S # --succinct
        fi
    done
    exit 0
fi

# enable extra debugging most of the time
if [ "$mode" == "release" -o "$mode" == "zip" -o "$mode" == "tarball" ]
then
    echo -n
else
    export FONTTOOLS_LOOKUP_DEBUGGING=1
fi

if [ "$mode" == "vbuild" ]
then
    rm source/stat.yaml tirobuild.yaml
    mode=make
    submode=variable
fi

if [ "$mode" == "make" ]
then
    if [ -d source/masters ]
    then
        for dspace in source/variable/*.designspace
        do
            if [ -f $dspace ]
            then
                if [ -x prevariable ]
                then
                    echo "running prevariable"
                    source prevariable
                fi
                for fea in source/masters/*.ufo/*.fea
                do
                    if [ -f $fea ]
                    then
                        sed 's/.null//g' $fea > features.fea
                        mv -v features.fea $fea
                    fi
                done

                if [ "$submode" == "otf" -o -z "$submode" ]
                then
                    echo "building otf instance fonts from $dspace"
                    fontmake -m $dspace --keep-overlaps --check-compatibility -i -o otf
                fi
                if [ "$submode" == "ttf" -o -z "$submode" ]
                then
                    echo "building ttf instance fonts from $dspace"
                    fontmake -m $dspace --keep-overlaps --check-compatibility -i -o ttf
                fi

                if [ -f source/stat.yaml ]
                then
                    echo "smith flow (sf)"
                    designpath=${dspace%.designspace}
                    designfile=${designpath#source/variable/}
                    outfile=${designfile}.ttf
                    fontmake -m $dspace --output-path $outfile -o variable --feature-writer None --filter DecomposeTransformedComponentsFilter # --verbose DEBUG
                    vardir=sf
                    varbase=${vardir}/${designfile}
                    varttf=${varbase}.ttf
                    varweb=${varbase}.woff2
                    mkdir -p $vardir
                    gftools fix-font --include-source-fixes -o $varttf $outfile
                    gftools gen-stat --inplace --src source/stat.yaml $varttf
                    psfwoffit -m source/*-WOFF-metadata.xml --woff2 $varweb $varttf
                fi
            fi
        done

        if [ "$submode" == "variable" -o -z "$submode" ]
        then
            if [ -f googlefonts.yaml ]
            then
                echo "Google Fonts (gf)"
                gftools builder $GFTOOLS_BUILDER googlefonts.yaml
            fi

            if [ -f tirobuild.yaml ]
            then
                echo "Tiro Build (tb)"
                python3 $HOME/builds/tirotools/Builder/tirobuild.py tirobuild.yaml
            fi
        fi

        if [ -d sf ]
        then
            mkdir sf_ttf
            cp -v sf/*.ttf sf_ttf
        fi
        if [ -d gf ]
        then
            mkdir gf_ttf gr_ttf

            for google in gf/*
            do
                pushd $google
                for sfnt in *.*
                do
                    for dir in ../../g?_ttf
                    do
                        cp -v $sfnt $dir
                    done
                done
                popd
            done

            pushd gr_ttf
            for sfnt in *.*
            do
                cleaner=${sfnt/\[wght\]/}
                cleaner=${cleaner/\[wdth,wght\]/}
                mv -v $sfnt $cleaner
            done
            popd
        fi
        if [ -d output ]
        then
            mkdir tb_ttf
            cp -v output/tirobuild/*/TTFVF/*.ttf tb_ttf
        fi

        rm vresults
        ln -s gr_ttf vresults
        pushd vresults
        mkdir web
        mv -v *.woff2 web
        popd

        for output in instance_*
        do
            if [ -d $output ]
            then
                fixttf $output/*.?tf
            fi
        done
    else
        for dspace in source/*.designspace
        do
            if [ -f $dspace ]
            then
                echo "building otf and ttf static fonts from $dspace"
                fontmake -m $dspace --check-compatibility -o otf ttf
            fi
        done
    fi

    exit 0
fi

if [ "$mode" == "install" -o "$mode" == "windows" -o "$mode" == "apple" ]
then
    for dir in $guest/xtf $guest
    do
        # smith
        cp -v results/*.ttf $dir

        # fontmake
        cp -a *_?tf $dir
    done
    cp -v results/web/*.woff2 $guest/web

    interpolate=""
    if [ -d source/masters ]
    then
        interpolate="-i"
    fi

    pushd tests
    for ftml in *.ftml
    do
        stem=${ftml%.ftml}
        odt=$guest/$stem.odt
        if [ $ftml -nt $odt ]
        then
            ftml2odt $ftml $odt
            ftml2txt $interpolate -o $guest $ftml
            unix2dos -n $guest/txt/$stem.txt $guest/$stem.txt
            cp $guest/txt/$stem.txt generated/$stem.htxt
        fi
    done
    popd

    if [ "$mode" != "apple" ]
    then
        rsync -v -a --delete documentation $guest
    fi

    if [ "$mode" == "install" ]
    then
        exit 0
    fi
fi

if [ "$mode" == "windows" ]
then
    # InDesign
    folder="$HOME/guest/Document Fonts"

    pushd tests
    rsync -v -a --delete $ref/ "$folder"
    cp -v ../results/*.ttf "$folder"

    # plain text
    if [ -d generated ]
    then
        for txt_file in *.txt generated/*.txt
        do
            if [ -f $txt_file ]
            then
                txt=$(basename $txt_file)
                unix2dos -n $txt_file $guest/$txt
            fi
        done
    fi

    popd

    exit 0
fi

if [ "$mode" == "apple" ]
then
    ssh-add -l
    if [ $? -gt 0 ]
    then
        ssh-add ~/.ssh/id_ed25519_home
    fi
    chmod -R go+Xr $guest/web
    rsync -v -a --delete $guest/web/ nrsi.sil.org:/var/www/fonts/

    exit 0
fi

if [ "$mode" == "data" ]
then
    touch .active $priv/.active

    rm -f $guest/*.*
    rm -rf $guest/{xtf,txt,web,sfm,pdfs,sile}
    mkdir -p $guest/{xtf,txt,web,sfm,pdfs,sile}

    for genftml in tools tools/bin
    do
        if [ $genftml/psfgenftml.py -nt tests/allchars.ftml ]
        then
            if [ -x makeftml ]
            then
                ./makeftml
            fi
        fi
    done

    # web apps
    ln -v -f web/*.html web/*.css tools/*.html $var/* $ht $guest/web

    pushd tests

    # windows apps
    ln -v -f *.indd *.odt *.docx $guest

    /bin/rm -rf generated
    mkdir generated
    for htxt in *.htxt
    do
        if [ -f $htxt ]
        then
            unikey -o generated/${htxt%.htxt}-plain.txt $htxt
        fi
    done

    ftml2txt $interpolate -o $guest -s $HOME/script/SP1 *.ftml

    cp /dev/null $wl

    for txt_file in *.txt generated/*.txt
    do
        if [ -f $txt_file ]
        then
            cat $txt_file | sed 's/ /\n/g' | sed 's/,//g' >> $wl
        fi
    done

    for txt_file in $guest/txt/*.txt
    do
        if [ -f $txt_file ]
        then
            cat $txt_file >> $wl
        fi
    done
    unix2dos $guest/txt/*.txt

    psfcheckftml
    for ftml in *.ftml
    do
        # check for valid files
        xmllint --noout --dtdvalid $HOME/builds/ftml/FTML.dtd $ftml
        if [ $? -gt 0 ]
        then
            echo "ftml file $ftml is invalid"
        fi
    done
    popd

    # TypeTuner files
    if [ -d source/typetuner ]
    then
        pushd source/typetuner
        for tag in all set
        do
            dtd=feat_${tag}.dtd
            for xml in feat_${tag}*.xml
            do
                echo xmllint --noout --dtdvalid $dtd $xml
                xmllint --noout --dtdvalid $dtd $xml
                if [ $? -gt 0 ]
                then
                    echo "TypeTuner XML file $xml is invalid"
                fi
            done
        done
        popd
    fi

    xhost +local:

    exit 0
fi

if [ "$mode" == "reference" ]
then
    pushd results
    for ttf in *.ttf # */*.ttf
    do
        if [ -f $ttf ]
        then
            rsync -v -a -R $ttf $ref
        fi
    done
    for ttf in tests/ftml/fonts/*.ttf # tests/ftml/fonts/*/*.ttf
    do
        if [ -f $ttf ]
        then
            rsync -v -a -R $ttf $cmp
        fi
    done
    popd

    pushd $ref
    ls -l -t *.ttf # */*.ttf
    popd

    exit 0
fi

if [ "$mode" == "update" ]
then
    gdcsv

    for ufo in source/*.ufo source/masters/*.ufo
    do
        if [ -d $ufo ]
        then
            if [ OFL.txt -nt $ufo/fontinfo.plist ]
            then
                psfsetkeys -k "copyright" --filepart OFL.txt $ufo
                psfsetkeys -k "openTypeNameLicense" --file OFL.txt $ufo
            fi
        fi
    done

    /bin/rm -rf {source,tests}/{'',masters}/{backups,logs}

    exit 0
fi

if [ "$mode" == "version" ]
then
    version="$submode"
    for ufo in source/*.ufo source/masters/*.ufo
    do
        if [ -d $ufo ]
        then
            psfsetversion $ufo "$version"
        fi
    done
    bumpversion --config-file $bv --allow-dirty --new-version "$version" major
    exit 0
fi

big=$(echo $locl/tests)
if [ "$mode" == "bigtest" ]
then
    if [ -d $big ]
    then
        cp -p -v $big/* tests
    fi
    mode=test
fi

extra=$(echo $priv/tests)
if [ -d $extra -a "$mode" != "pdfs" ]
then
    export SMITH_EXTRATESTDIR=$extra
    echo "SMITH_EXTRATESTDIR is $SMITH_EXTRATESTDIR"
fi

# enable even more dubugging
if [ "$mode" == "debug" ]
then
    gdcsv-debug
    mode=build
fi

# run smith
shift
$HOME/.local/bin/smith "$mode" "$@" $FLOWARGS

# flatten test directory hierarchy
if [ "$mode" == "ptest" ]
then
    pushd results/tests/test
    for html in */*.html
    do
        if [ -f $html ]
        then
            dotdot=$(echo $html | sed -e 's/\//_/g')
            mv $html $dotdot
        fi
    done

    for fonts in */fonts_*
    do
        if [ -d $fonts ]
        then
            dotdot=$(basename $fonts)
            mv $fonts/*.ttf $dotdot
        fi
    done

    for fonts in */fonts_*0*
    do
        if [ -d $fonts ]
        then
            rm -rf $(dirname $fonts)
        fi
    done
    popd
fi

# move created PDFs to guest
if [ "$mode" == "pdfs" -o "$mode" == "sile" ]
then
    cp -p -v results/tests/$mode/*.pdf $guest/$mode
fi
